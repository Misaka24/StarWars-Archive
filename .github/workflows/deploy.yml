name: Deploy StarWars Archive (3 Modes)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkoutï¼ˆéœ€è¦æœ€è¿‘ä¸¤æ¬¡ commitï¼‰
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2ï¸âƒ£ Detect deploy mode
      - name: Detect deploy mode
        id: mode
        shell: bash
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD || true)
          echo "Changed files:"
          echo "$CHANGED"

          MODE="none"

          if echo "$CHANGED" | grep -q '^rawsite/'; then
            MODE="rawsite"
          elif echo "$CHANGED" | grep -q '^docs/'; then
            MODE="docs"
          fi

          echo "deploy_mode=$MODE" >> $GITHUB_OUTPUT

          if [ "$MODE" = "none" ]; then
            echo "No deployable changes."
            exit 0
          fi

      # 3ï¸âƒ£ Build VitePressï¼ˆdocs æ¨¡å¼ï¼‰
      - name: Setup Node
        if: steps.mode.outputs.deploy_mode == 'docs'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build VitePress
        if: steps.mode.outputs.deploy_mode == 'docs'
        shell: bash
        run: |
          cd docs
          npm ci
          npm run docs:build

      # 4ï¸âƒ£ docsï¼šä¸Šä¼  dist â†’ ä¸´æ—¶ç›®å½•ï¼ˆğŸ”¥ ä¿®å¤ç›®å½•å åŠ ï¼‰
      - name: Upload docs dist to tmp
        if: steps.mode.outputs.deploy_mode == 'docs'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }}
          key: ${{ secrets.DEPLOY_KEY }}

          source: "docs/.vitepress/dist/**"
          target: "/tmp/starwars-archive-deploy"

          strip_components: 3   # â­ docs/.vitepress/dist â†’ å¹³é“º
          rm: true

      # 5ï¸âƒ£ rawsiteï¼šä¸Šä¼ åŸç”Ÿç«™ç‚¹ â†’ ä¸´æ—¶ç›®å½•
      - name: Upload rawsite to tmp
        if: steps.mode.outputs.deploy_mode == 'rawsite'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }}
          key: ${{ secrets.DEPLOY_KEY }}

          source: "rawsite/**"
          target: "/tmp/starwars-archive-deploy"

          strip_components: 1   # â­ å»æ‰ rawsite/
          rm: true

      # 6ï¸âƒ£ ç»Ÿä¸€å‘å¸ƒåˆ°ç«™ç‚¹æ ¹ç›®å½•ï¼ˆä½ å·²ç»éªŒè¯æˆåŠŸçš„æ–¹æ¡ˆï¼‰
      - name: Publish to web root
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e

            mkdir -p /var/www/starwars-archive

            rsync -a --delete \
              /tmp/starwars-archive-deploy/ \
              /var/www/starwars-archive/

            chmod -R 755 /var/www/starwars-archive
